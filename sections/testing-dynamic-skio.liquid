<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: #f9f9f9;
    padding: 20px;
}

.bundle-builder {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 16px;
    padding: 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 2px solid #e0e0e0;
}

/* Buybox Container */
.bundle-buybox {
    padding: 32px;
}

/* Price Section */
.bundle-price {
    margin-bottom: 20px;
}

.bundle-price__display {
    display: flex;
    align-items: baseline;
    gap: 12px;
}

.bundle-price__current {
    font-size: 28px;
    font-weight: 700;
    color: #1e4845;
}

.bundle-price__original {
    font-size: 20px;
    color: #999;
    text-decoration: line-through;
}

/* Description Section */
.bundle-description {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e0e0e0;
}

.bundle-description__text {
    font-size: 14px;
    line-height: 1.6;
    color: #323232;
}

/* Progress Bar - New Design */
.bundle-progress {
    margin-bottom: 24px;
    padding: 20px 20px 50px 20px;
    background: #FFFBF7FF;
    border-radius: 12px;
    border: 2px solid #e0e0e0;
}

.bundle-progress__label {
    font-size: 14px;
    font-weight: 600;
    color: #323232;
    margin-bottom: 20px;
    text-align: center;
}

.bundle-progress__track {
    position: relative;
    height: 80px;
    display: flex;
    align-items: center;
    padding: 0 30px;
}

.bundle-progress__line {
    position: absolute;
    left: 30px;
    right: 30px;
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    top: 40px;
}

.bundle-progress__line-fill {
    height: 100%;
    background: #1e4845;
    border-radius: 2px;
    transition: width 0.3s ease;
    width: 0%;
}

.bundle-progress__stops {
    position: relative;
    display: flex;
    justify-content: space-between;
    width: 100%;
    z-index: 2;
}

.bundle-progress__stop {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    justify-content: center;
}

.bundle-progress__stop-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: 4px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #999;
    transition: all 0.3s ease;
    position: relative;
}

.bundle-progress__stop.active .bundle-progress__stop-circle {
    border-color: #1e4845;
    background: #1e4845;
    color: white;
}

.bundle-progress__stop-label {
    position: absolute;
    top: 50px;
    font-size: 12px;
    font-weight: 600;
    color: #666;
    white-space: nowrap;
}

.bundle-progress__stop.active .bundle-progress__stop-label {
    color: #1e4845;
}

.bundle-progress__stop-price {
    position: absolute;
    top: 68px;
    font-size: 11px;
    color: #999;
    white-space: nowrap;
}

.bundle-progress__stop.active .bundle-progress__stop-price {
    color: #1e4845;
    font-weight: 600;
}

.bundle-progress__badge {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: #1e4845;
    color: white;
    font-size: 9px;
    font-weight: 700;
    padding: 3px 6px;
    border-radius: 8px;
    text-transform: uppercase;
    white-space: nowrap;
}

.bundle-progress__badge--popular {
    background: #1e4845;
    color: white;
}

/* Product Grid - Stacked Layout */
.product-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.product-card {
    border: 2px solid #e0e0e0;
    border-radius: 12px;
    padding: 0;
    transition: all 0.3s ease;
    position: relative;
    display: flex;
    align-items: stretch;
    gap: 0;
    background: #FFFBF7FF;
    overflow: hidden;
}

.product-card.selected {
    border-color: #1e4845;
    background: #FFFBF7FF;
}

.product-card__image-wrapper {
    position: relative;
    flex-shrink: 0;
    width: 120px;
    align-self: stretch;
    overflow: hidden;
    background: #f5f5f5;
    border-radius: 10px 0 0 10px;
}

.product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.product-card__content {
    display: flex;
    flex: 1;
    align-items: center;
    gap: 16px;
    padding: 16px;
}

.product-card__info {
    flex: 1;
    min-width: 0;
}

.product-card__title {
    font-size: 16px;
    font-weight: 600;
    color: #323232;
    margin-bottom: 4px;
}

.product-card__description {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

.product-card__controls {
    flex-shrink: 0;
    display: flex;
    gap: 8px;
}

.quantity-selector {
    display: none;
    align-items: center;
    gap: 8px;
    background: #FFFBF7FF;
    border-radius: 8px;
    padding: 6px;
}

.product-card.selected .quantity-selector {
    display: flex;
}

.product-card.selected .add-button {
    display: none;
}

.quantity-button {
    width: 32px;
    height: 32px;
    border: none;
    background: #1e4845;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.quantity-button:hover:not(:disabled) {
    background: #153634;
}

.quantity-button:disabled {
    background: #ccc;
    cursor: not-allowed;
    opacity: 0.5;
}

.quantity-input {
    width: 40px;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 16px;
    font-weight: 600;
    color: #323232;
    padding: 0;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.add-button {
    padding: 10px 20px;
    background: #1e4845;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.add-button:hover {
    background: #153634;
}

.add-button:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* Free Gift Banner */
.free-gift-banner {
    position: relative;
    margin-bottom: 24px;
    padding: 20px 24px;
    background: linear-gradient(135deg, #1e4845 0%, #2a6460 100%);
    border-radius: 12px;
    color: white;
    overflow: hidden;
}

.free-gift-banner__content {
    position: relative;
    z-index: 1;
}

.free-gift-banner__text {
    font-size: 16px;
    font-weight: 600;
    line-height: 1.4;
    padding-right: 80px;
}

.free-gift-banner__value-badge {
    position: absolute;
    top: 16px;
    right: 16px;
    background: #FFD93D;
    color: #323232;
    font-size: 12px;
    font-weight: 700;
    padding: 8px 12px;
    border-radius: 20px;
    transform: rotate(5deg);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

/* Purchase Type Selection */
.purchase-type {
    margin-bottom: 20px;
    padding: 20px;
    background: #FFFBF7FF;
    border-radius: 12px;
    border: 2px solid #e0e0e0;
}

.purchase-type__label {
    font-size: 16px;
    font-weight: 600;
    color: #323232;
    margin-bottom: 12px;
}

.purchase-type__options {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.purchase-type__option {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.purchase-type__option:has(input:checked) {
    border-color: #1e4845;
    background: white;
}

.purchase-type__option:hover {
    border-color: #1e4845;
}

.purchase-type__option input[type="radio"] {
    margin: 0;
    accent-color: #1e4845;
}

.purchase-type__option-label {
    font-size: 14px;
    font-weight: 500;
    color: #323232;
}

.purchase-type__select-field {
    max-height: 0;
    opacity: 0;
    visibility: hidden;
    overflow: hidden;
    transition: all 0.3s ease;
}

.purchase-type__select-field.visible {
    max-height: 100px;
    opacity: 1;
    visibility: visible;
}

.purchase-type__select {
    width: 100%;
    padding: 12px;
    border: 2px solid #1e4845;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    color: #323232;
}

.purchase-type__select:focus {
    outline: none;
    border-color: #1e4845;
}

/* Add to Cart Button */
.cart-section {
    padding: 0 32px 32px 32px;
}

.add-to-cart-button {
    width: 100%;
    padding: 18px;
    background: #1e4845;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
}

.add-to-cart-button:hover:not(:disabled) {
    background: #153634;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(30, 72, 69, 0.3);
}

.add-to-cart-button:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.add-to-cart-button__content {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: nowrap;
    justify-content: center;
}

.add-to-cart-button__prices {
    display: flex;
    align-items: center;
    gap: 8px;
}

.add-to-cart-button__price {
    font-size: 18px;
}

.add-to-cart-button__savings {
    font-size: 14px;
    text-decoration: line-through;
    opacity: 0.7;
}

.loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

.bundle-progress__stop.active:after {
    display: none;
}

.add-to-cart-button.loading .loading-spinner {
    display: block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.hidden {
    display: none !important;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    body {
        padding: 10px;
    }

    .bundle-builder {
        border-radius: 12px;
    }

    .bundle-buybox {
        padding: 20px 0;
    }

    .bundle-price__current {
        font-size: 24px;
    }

    .bundle-price__original {
        font-size: 18px;
    }

    .bundle-description__text {
        font-size: 13px;
    }

    .bundle-progress {
        padding: 10px 0px 30px 0px;
    }

    .bundle-progress__track {
        padding: 0 20px;
    }

    .bundle-progress__line {
        left: 20px;
        right: 20px;
    }

    .bundle-progress__stop-circle {
        width: 35px;
        height: 35px;
        font-size: 14px;
    }

    .bundle-progress__stop-label {
        font-size: 10px;
        top: 45px;
    }

    .bundle-progress__stop-price {
        font-size: 10px;
        top: 60px;
    }

    .bundle-progress__badge {
        font-size: 8px;
        padding: 2px 5px;
        top: -20px;
    }

    .product-card {
        padding: 0;
    }

    .product-card__image-wrapper {
        width: 80px;
    }

    .product-card__content {
        padding: 12px;
        gap: 12px;
    }

    .product-card__title {
        font-size: 14px;
    }

    .product-card__description {
        font-size: 12px;
    }

    .quantity-button {
        width: 28px;
        height: 28px;
        font-size: 16px;
    }

    .quantity-input {
        width: 35px;
        font-size: 14px;
    }

    .add-button {
        padding: 8px 16px;
        font-size: 13px;
    }

    .free-gift-banner {
        padding: 16px;
    }

    .free-gift-banner__text {
        font-size: 14px;
        padding-right: 70px;
    }

    .free-gift-banner__value-badge {
        font-size: 10px;
        padding: 6px 10px;
        top: 12px;
        right: 12px;
    }

    .purchase-type {
        padding: 16px;
    }

    .purchase-type__label {
        font-size: 14px;
    }

    .purchase-type__options {
        flex-direction: column;
        gap: 8px;
    }

    .purchase-type__option {
        padding: 10px;
    }

    .purchase-type__option-label {
        font-size: 13px;
    }

    .purchase-type__select {
        padding: 10px;
        font-size: 13px;
    }

    .cart-section {
        padding: 0 20px 20px 20px;
    }

    .add-to-cart-button {
        padding: 14px 12px;
        font-size: 15px;
    }

    .add-to-cart-button__content {
        flex-wrap: nowrap;
        gap: 8px;
    }

    .add-to-cart-button__text {
        white-space: nowrap;
    }

    .add-to-cart-button__price {
        font-size: 15px;
    }

    .add-to-cart-button__savings {
        font-size: 12px;
    }
}

@media (max-width: 480px) {
    .bundle-buybox {
        padding: 16px 0;
    }

    .bundle-price__current {
        font-size: 22px;
    }

    .bundle-price__original {
        font-size: 16px;
    }

    .cart-section {
        padding: 0 16px 16px 16px;
    }

    .add-to-cart-button {
        padding: 12px 10px;
        font-size: 14px;
    }

    .add-to-cart-button__price {
        font-size: 14px;
    }

    .add-to-cart-button__savings {
        font-size: 11px;
    }
}
</style>

<bundle-builder class="bundle-builder">
    <div class="bundle-buybox">
        <!-- Price Display -->
        <div class="bundle-price">
            <div class="bundle-price__display">
                <span class="bundle-price__current" js-total-discounted-price>$0.00</span>
                <span class="bundle-price__original hidden" js-total-price>$0.00</span>
            </div>
        </div>

        <!-- Description -->
        <div class="bundle-description">
            <p class="bundle-description__text">
                Providing your body the hydration and gut-supporting ingredients it needs to help balance your microbiome and improve digestion. Delivering probiotics, apple cider vinegar, fibre and trace minerals to strengthen your gut – which is essential for removing toxins, building a healthy immune system and guarding against inflammation.
            </p>
        </div>

        <!-- Progress Bar -->
        <div class="bundle-progress">
            <div class="bundle-progress__label">BUILD YOUR BUNDLE</div>
            <div class="bundle-progress__track">
                <div class="bundle-progress__line">
                    <div class="bundle-progress__line-fill" js-progress-line-fill></div>
                </div>
                <div class="bundle-progress__stops" js-bundle-progress-bar>
                    <!-- Progress stops will be injected here -->
                </div>
            </div>
        </div>

        <!-- Product Grid - Stacked Layout -->
        <div class="product-grid" js-byob-product-bundle-grid>
            <!-- Product cards will be injected here -->
        </div>

        <!-- Free Gift Banner -->
        <div class="free-gift-banner">
            <div class="free-gift-banner__content">
                <div class="free-gift-banner__text">
                    Free Shaker Cup with Your First Subscription!
                </div>
            </div>
            <div class="free-gift-banner__value-badge">
                $20 value
            </div>
        </div>

        <!-- Purchase Type Selection -->
        <div class="purchase-type">
            <div class="purchase-type__label">Purchase Type:</div>
            <div class="purchase-type__options">
                <label class="purchase-type__option">
                    <input type="radio" name="purchase_type" value="subscription" js-skio-bundle-subscription checked>
                    <span class="purchase-type__option-label">Subscribe & Save 20%</span>
                </label>
                <label class="purchase-type__option">
                    <input type="radio" name="purchase_type" value="onetime" js-skio-bundle-onetime>
                    <span class="purchase-type__option-label">One-time purchase</span>
                </label>
            </div>
            <div class="purchase-type__select-field visible" js-skio-bundle-select-field>
                <select class="purchase-type__select" js-custom-option-select js-byob-custom-option-select>
                    <!-- Options will be injected here -->
                </select>
            </div>
        </div>
    </div>

    <!-- Add to Cart Section -->
    <div class="cart-section">
        <button class="add-to-cart-button" js-bundle-addToCart-btn disabled>
            <div class="add-to-cart-button__content">
                <span class="add-to-cart-button__text" js-bundle-button-text>Select 3 more items</span>
                <div class="add-to-cart-button__prices hidden" js-bundle-prices>
                    <span class="add-to-cart-button__price" js-bundle-button-price>$0.00</span>
                    <span class="add-to-cart-button__savings hidden" js-bundle-button-savings>$0.00</span>
                </div>
            </div>
            <div class="loading-spinner loading__spinner"></div>
        </button>
    </div>

    <!-- Hidden data attributes -->
    <div style="display: none;">
        <div js-bundle-progress-bar-wrapper style="opacity: 0;"></div>
        <div js-product-bundle-subscription-wrapper style="opacity: 0;"></div>
    </div>
</bundle-builder>

<script>
// Global variables for Skio data
let skioDynamicBundlesizeInterval = [];
let skioDynamicBundleVariantPrice = 0;
let skioDynamicBundleMinLimit = 3;
let skioDynamicBundleMaxLimit = 5;
let skioDynamicBundlePrices = {};

// Subscription shaker variant ID to add
const SUBSCRIPTION_SHAKER_VARIANT_ID = 42218766467154;

class BundleBuilder extends HTMLElement {
    constructor() {
        super();
        
        // Selectors
        this.productWrapperSelector = "[js-product-wrapper]";
        this.addToSetBtn = "[js-ats-btn]";
        this.incrementBtnSelector = "[js-quantity-increment]";
        this.decrementBtnSelector = "[js-quantity-decrement]";
        this.quantityInputSelector = "[js-quantity-input]";
        
        // DOM elements
        this.addToCartBtn = this.querySelector("[js-bundle-addToCart-btn]");
        this.buttonText = this.querySelector("[js-bundle-button-text]");
        this.bundlePrices = this.querySelector("[js-bundle-prices]");
        this.bundleButtonPrice = this.querySelector("[js-bundle-button-price]");
        this.bundleButtonSavings = this.querySelector("[js-bundle-button-savings]");
        this.sellingPlanSelect = this.querySelector("[js-custom-option-select]");
        this.totalPrice = this.querySelectorAll("[js-total-price]");
        this.totalDiscountedPrice = this.querySelectorAll("[js-total-discounted-price]");
        this.progressLineFill = this.querySelector("[js-progress-line-fill]");
        
        // Radio buttons and select field
        this.oneTimeRadio = this.querySelector("[js-skio-bundle-onetime]");
        this.subscriptionRadio = this.querySelector("[js-skio-bundle-subscription]");
        this.selectField = this.querySelector("[js-skio-bundle-select-field]");
        
        // State
        this.products = [];
        this.sellingPlanId = this.sellingPlanSelect?.value || null;
        this.sellingPlanName = null;
        this.minLimit = 3;
        this.maxLimit = 5;
        
        this.handleSubscriptionToggle();
        this.initializeEventListeners();
        
        // Listen for Skio data initialization
        document.addEventListener('skioBundlePrice:init', () => {
            this.minLimit = skioDynamicBundleMinLimit;
            this.maxLimit = skioDynamicBundleMaxLimit;
            this.updateStatus();
            this.updatePrice();
            this.setInitialPrice();
        });
    }
    
    setInitialPrice() {
        // Set initial price for 3 items with subscription
        if (skioDynamicBundlePrices[3]) {
            const pricing = skioDynamicBundlePrices[3];
            
            this.totalPrice.forEach((price) => {
                price.innerText = `$${pricing.subscription.originalPrice.toFixed(2)}`;
                price.classList.remove("hidden");
            });
            
            this.totalDiscountedPrice.forEach((discountPrice) => {
                discountPrice.innerText = `$${pricing.subscription.discountedPrice.toFixed(2)}`;
            });
        }
    }
    
    initializeEventListeners() {
        // Click event listener
        this.addEventListener("click", (event) => {
            // Handle "Add to Set" button clicks
            this.querySelectorAll(this.addToSetBtn).forEach((addToSet) => {
                if (addToSet.contains(event.target)) {
                    const parent = addToSet.closest(this.productWrapperSelector);
                    parent.querySelector(this.quantityInputSelector).stepUp();
                    parent.classList.add("selected");
                    this.addProductToBox(parent);
                    this.updatePrice();
                }
            });
            
            // Handle increment button clicks
            this.querySelectorAll(this.incrementBtnSelector).forEach((incrementBtn) => {
                if (incrementBtn.contains(event.target)) {
                    const parent = incrementBtn.closest(this.productWrapperSelector);
                    if (this.products.length < this.maxLimit) {
                        parent.querySelector(this.quantityInputSelector).stepUp();
                        this.addProductToBox(parent);
                        this.updatePrice();
                    }
                }
            });
            
            // Handle decrement button clicks
            this.querySelectorAll(this.decrementBtnSelector).forEach((decrementBtn) => {
                if (decrementBtn.contains(event.target)) {
                    const parent = decrementBtn.closest(this.productWrapperSelector);
                    const currentProductId = Number(parent.dataset.productId);
                    const quantityField = parent.querySelector(this.quantityInputSelector);
                    
                    if (Number(quantityField.value) > 0) {
                        quantityField.stepDown();
                    }
                    
                    this.removeProductFromBox(currentProductId, parent);
                    this.updatePrice();
                }
            });
        });
        
        // Selling plan change listener
        if (this.sellingPlanSelect) {
            this.sellingPlanSelect.addEventListener("change", (e) => {
                this.sellingPlanId = e.currentTarget.value;
                this.updatePrice();
                
                const selectedOption = e.target.options[e.target.selectedIndex];
                this.sellingPlanName = selectedOption.getAttribute("data-plan-name");
            });
        }
        
        // Add to cart button listener
        this.addToCartBtn.addEventListener("click", (e) => {
            e.preventDefault();
            this.addBundleToCart();
        });
    }
    
    async getCart() {
        const response = await fetch(`/cart.json`);
        const json = await response.json();
        return json;
    }
    
    async addBundleToCart() {
        // Group products by variant ID and count quantities
        const groupedProducts = {};
        this.products.forEach(product => {
            if (groupedProducts[product.id]) {
                groupedProducts[product.id].quantity++;
            } else {
                groupedProducts[product.id] = { ...product, quantity: 1 };
            }
        });
        
        // Build cart items array according to Shopify format
        const items = Object.values(groupedProducts).map(product => {
            const item = {
                id: product.id,
                quantity: product.quantity
            };
            
            // Add selling_plan if subscription is selected
            if (this.subscriptionRadio?.checked && this.sellingPlanId) {
                item.selling_plan = parseInt(this.sellingPlanId);
            }
            
            // Add parent_id (Skio box ID) if available
            if (window.skioDynamicBoxId) {
                item.parent_id = parseInt(window.skioDynamicBoxId);
            }
            
            return item;
        });
        
        // Check if subscription is selected and add the subscription variant if needed
        if (this.subscriptionRadio?.checked) {
            try {
                const cart = await this.getCart();
                const hasSubscriptionVariant = cart.items.some(item => 
                    item.variant_id === SUBSCRIPTION_SHAKER_VARIANT_ID
                );
                
                if (!hasSubscriptionVariant) {
                    items.push({
                        id: SUBSCRIPTION_SHAKER_VARIANT_ID,
                        quantity: 1
                    });
                }
            } catch (error) {
                console.error("Error checking cart:", error);
            }
        }
        
        const formData = {
            items: items
        };
        
        // Show loading state
        this.addToCartBtn.classList.add("loading");
        this.addToCartBtn.disabled = true;
        
        try {
            const response = await fetch(window.Shopify.routes.root + 'cart/add.js', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            window.setTimeout(() => {
                window.Rebuy.SmartCart.show();
            }, 1500);
            
            // Remove loading state
            this.addToCartBtn.classList.remove("loading");
            this.addToCartBtn.disabled = false;
            
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('There was an error adding items to cart. Please try again.');
            
            // Remove loading state
            this.addToCartBtn.classList.remove("loading");
            this.addToCartBtn.disabled = false;
        }
    }
    
    updatePrice() {
        const totalItems = this.products.length;
        
        if (totalItems < this.minLimit) {
            // Show default 3-pack pricing when no items selected
            if (skioDynamicBundlePrices[3]) {
                const pricing = skioDynamicBundlePrices[3];
                
                if (this.subscriptionRadio?.checked) {
                    this.totalPrice.forEach((price) => {
                        price.innerText = `$${pricing.subscription.originalPrice.toFixed(2)}`;
                        price.classList.remove("hidden");
                    });
                    
                    this.totalDiscountedPrice.forEach((discountPrice) => {
                        discountPrice.innerText = `$${pricing.subscription.discountedPrice.toFixed(2)}`;
                    });
                } else {
                    this.totalPrice.forEach((price) => {
                        price.innerText = `$${pricing.oneTime.originalPrice.toFixed(2)}`;
                        price.classList.remove("hidden");
                    });
                    
                    this.totalDiscountedPrice.forEach((discountPrice) => {
                        discountPrice.innerText = `$${pricing.oneTime.discountedPrice.toFixed(2)}`;
                    });
                }
            }
            this.updateProgressBar();
            return;
        }
        
        const pricing = skioDynamicBundlePrices[totalItems];
        if (!pricing) {
            this.updateProgressBar();
            return;
        }
        
        if (this.subscriptionRadio?.checked) {
            this.totalPrice.forEach((price) => {
                price.innerText = `$${pricing.subscription.originalPrice.toFixed(2)}`;
                price.classList.remove("hidden");
            });
            
            this.totalDiscountedPrice.forEach((discountPrice) => {
                discountPrice.innerText = `$${pricing.subscription.discountedPrice.toFixed(2)}`;
            });
            
            if (this.bundleButtonPrice) {
                this.bundleButtonPrice.innerText = `$${pricing.subscription.discountedPrice.toFixed(2)}`;
            }
            
            if (this.bundleButtonSavings) {
                this.bundleButtonSavings.innerText = `$${pricing.subscription.originalPrice.toFixed(2)}`;
                this.bundleButtonSavings.classList.remove("hidden");
            }
        } else {
            this.totalPrice.forEach((price) => {
                price.innerText = `$${pricing.oneTime.originalPrice.toFixed(2)}`;
                price.classList.remove("hidden");
            });
            
            this.totalDiscountedPrice.forEach((discountPrice) => {
                discountPrice.innerText = `$${pricing.oneTime.discountedPrice.toFixed(2)}`;
            });
            
            if (this.bundleButtonPrice) {
                this.bundleButtonPrice.innerText = `$${pricing.oneTime.discountedPrice.toFixed(2)}`;
            }
            
            if (this.bundleButtonSavings) {
                this.bundleButtonSavings.innerText = `$${pricing.oneTime.originalPrice.toFixed(2)}`;
                this.bundleButtonSavings.classList.remove("hidden");
            }
        }
        
        this.updateProgressBar();
    }
    
    updateProgressBar() {
        const totalItems = this.products.length;
        
        // Update progress stops
        this.querySelectorAll("[js-progress-bar-stop]").forEach((stop) => {
            const packSize = parseInt(stop.dataset.pack);
            
            if (totalItems >= packSize) {
                stop.classList.add("active");
            } else {
                stop.classList.remove("active");
            }
        });
        
        // Update progress line fill
        if (this.progressLineFill && skioDynamicBundlesizeInterval.length > 0) {
            const minSize = skioDynamicBundlesizeInterval[0];
            const maxSize = skioDynamicBundlesizeInterval[skioDynamicBundlesizeInterval.length - 1];
            const range = maxSize - minSize;
            
            let percentage = 0;
            if (totalItems >= maxSize) {
                percentage = 100;
            } else if (totalItems >= minSize) {
                percentage = ((totalItems - minSize) / range) * 100;
            }
            
            this.progressLineFill.style.width = `${percentage}%`;
        }
    }
    
    addProductToBox(parent) {
        const imageUrl = parent.dataset.productImageUrl;
        const variantId = Number(parent.dataset.variantId);
        const productId = Number(parent.dataset.productId);
        const title = parent.dataset.productTitle;
        const price = Number(parent.dataset.productPrice);
        const customPrice = Number(parent.dataset.productCustomPrice) || 0;
        
        this.products.push({
            id: variantId,
            productId,
            imageUrl,
            title,
            price,
            customPrice,
            quantity: 1
        });
        
        this.updateStatus();
    }
    
    removeProductFromBox(id, parent) {
        const otherProducts = this.products.filter((product) => product.productId !== id);
        const currentProducts = this.products.filter((product) => product.productId === id);
        
        currentProducts.splice(0, 1);
        
        if (currentProducts.length === 0) {
            parent.classList.remove("selected");
        }
        
        this.products = [...currentProducts, ...otherProducts];
        this.updateStatus();
    }
    
    updateStatus() {
        const totalItems = this.products.length;
        const remaining = this.minLimit - totalItems;
        
        // Update increment buttons based on max limit
        if (totalItems >= this.maxLimit) {
            this.querySelectorAll(this.incrementBtnSelector).forEach((item) => item.disabled = true);
            this.querySelectorAll(this.addToSetBtn).forEach((item) => item.disabled = true);
        } else {
            this.querySelectorAll(this.incrementBtnSelector).forEach((item) => item.disabled = false);
            this.querySelectorAll(this.addToSetBtn).forEach((item) => item.disabled = false);
        }
        
        // Update button text and state
        if (totalItems >= this.minLimit) {
            this.addToCartBtn.disabled = false;
            this.buttonText.textContent = "Add Bundle to Cart";
            this.bundlePrices.classList.remove("hidden");
        } else {
            this.addToCartBtn.disabled = true;
            const itemWord = remaining === 1 ? 'item' : 'items';
            this.buttonText.textContent = `Select ${remaining} more ${itemWord}`;
            this.bundlePrices.classList.add("hidden");
        }
    }

    handleSubscriptionToggle() {
        if (!this.oneTimeRadio || !this.subscriptionRadio || !this.selectField) {
            return;
        }
        
        const toggleVisibility = () => {
            if (this.subscriptionRadio.checked) {
                this.selectField.classList.add("visible");
            } else if (this.oneTimeRadio.checked) {
                this.selectField.classList.remove("visible");
            }
            
            this.updatePrice();
        };
        
        toggleVisibility();
        this.oneTimeRadio.addEventListener("change", toggleVisibility);
        this.subscriptionRadio.addEventListener("change", toggleVisibility);
    }
}

customElements.define("bundle-builder", BundleBuilder);

// Skio Dynamic Bundle Data Fetcher
async function skioDynamicBundleData() {
    const response = await fetch('https://api.skio.com/storefront-http/get-dynamic-box', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ "productPlatformId": "7506796249170" }),
    });

    const data = await response.json();

    const selectableProductVariants = data?.DynamicBox?.selectableProductVariants || [];
    skioDynamicBundlesizeInterval = data?.DynamicBox?.sizeInterval || [];
    skioDynamicBundleVariantPrice = selectableProductVariants?.[0]?.productVariants?.[0]?.price || 0;

    const fixedDiscountTier = data?.DynamicBox?.fixedDiscountTier;

    // Preserve your explicit ordering logic
    const productsData = [];
    selectableProductVariants.forEach(product => {
        if (product.productTitle === "A") productsData[0] = product;
        if (product.productTitle === "B") productsData[1] = product;
        if (product.productTitle === "C") productsData[2] = product;
    });

    const sellingPlanGroupConvertedInArray = Object.values(data?.DynamicBox?.sellingPlanGroup || {});
    const variantMappingConvertedInArray = sellingPlanGroupConvertedInArray?.[0]
        ? Object.values(sellingPlanGroupConvertedInArray[0].variantMapping || {})
        : [];
    const bundleVariantSubscriptionPrice = variantMappingConvertedInArray?.[0]?.adjustedPrice || 0;

    if (!productsData || !productsData.length) return;

    window.skioDynamicBoxId = data?.DynamicBox?.boxId;
    window.skioBynamicSellingPlanGroup = data?.DynamicBox?.sellingPlanGroup;

    const bundleproductGrid = document.querySelector('[js-byob-product-bundle-grid]');
    const bundleProgressBar = document.querySelector('[js-bundle-progress-bar]');
    const bundleproductSubcriptionOptions = document.querySelector('[js-byob-custom-option-select]');
    if (bundleproductGrid) bundleproductGrid.innerHTML = '';
    if (bundleProgressBar) bundleProgressBar.innerHTML = '';

    skioDynamicBundleMinLimit = skioDynamicBundlesizeInterval[0];
    skioDynamicBundleMaxLimit = skioDynamicBundlesizeInterval[skioDynamicBundlesizeInterval.length - 1];

    // Build progress bar stops + price tiers
    skioDynamicBundlesizeInterval.forEach((size, index) => {
        const badge = skioDynamicBundlesizeInterval.length - 2 == index ? '<div class="bundle-progress__badge bundle-progress__badge--popular">MOST POPULAR</div>' : 
                      skioDynamicBundlesizeInterval.length - 1 == index ? '<div class="bundle-progress__badge">BEST DEAL</div>' : '';
        
        // Calculate per-unit price with fixed discount applied
        let perUnitPrice = skioDynamicBundleVariantPrice;
        if (fixedDiscountTier && fixedDiscountTier[size.toString()]) {
            const discount = parseFloat(fixedDiscountTier[size.toString()]);
            const totalPrice = (skioDynamicBundleVariantPrice * size) - discount;
            perUnitPrice = totalPrice / size;
        }
        
        const progressStopHtml = `
            <div class="bundle-progress__stop" data-pack="${size}" js-progress-bar-stop data-index="${index}">
                ${badge}
                <div class="bundle-progress__stop-circle">${size}</div>
                <div class="bundle-progress__stop-label">${size} Pack</div>
                <div class="bundle-progress__stop-price">$${perUnitPrice.toFixed(2)}/ea</div>
            </div>
        `;
        bundleProgressBar.insertAdjacentHTML('beforeend', progressStopHtml);

        if (fixedDiscountTier) {
            const discount = parseFloat(fixedDiscountTier[size.toString()] || 0);
            
            skioDynamicBundlePrices[size] = {
                oneTime: {
                    originalPrice: skioDynamicBundleVariantPrice * size,
                    discountedPrice: ((skioDynamicBundleVariantPrice * size) - discount),
                },
                subscription: {
                    originalPrice: skioDynamicBundleVariantPrice * size,
                    discountedPrice: ((bundleVariantSubscriptionPrice * size) - discount),
                }
            };
        }
    });

    // Render products in stacked format
    productsData.forEach((product) => {
        if (!product) return;

        const translatedTitle = product.productTitle;
        const basePrice = product.productVariants?.[0]?.price || 0;

        const productHTML = `
            <div class="product-card"
                data-variant-id="${product.productVariants[0].platformId.split("/").pop()}"
                data-product-id="${product.productPlatformId.split("/").pop()}"
                data-product-title="${translatedTitle}"
                data-product-image-url="${product.productImageSrc}"
                data-product-price="${basePrice}"
                data-product-compare-price="${product.productVariants[0].compareAtPrice}"
                data-product-handle="${product.productHandle}"
                js-product-wrapper
            >
                <div class="product-card__image-wrapper">
                    <img src="${product.productImageSrc}" alt="${translatedTitle}" class="product-card__image">
                </div>
                <div class="product-card__content">
                    <div class="product-card__info">
                        <h3 class="product-card__title">${translatedTitle}</h3>
                        <p class="product-card__description">Delicious and refreshing flavor</p>
                    </div>
                    <div class="product-card__controls">
                        <div class="quantity-selector">
                            <button class="quantity-button" js-quantity-decrement>−</button>
                            <input type="number" class="quantity-input" min="0" value="0" readonly js-quantity-input>
                            <button class="quantity-button" js-quantity-increment>+</button>
                        </div>
                        <button class="add-button" js-ats-btn>ADD</button>
                    </div>
                </div>
            </div>
        `;
        bundleproductGrid.insertAdjacentHTML('beforeend', productHTML);
    });

    document.querySelector('[js-bundle-progress-bar-wrapper]').style.opacity = 1;

    // Subscription options
    const sellingPlanGroup = data?.DynamicBox?.sellingPlanGroup || {};
    const subscriptionPlans = Object.entries(sellingPlanGroup).map(([key, plan]) => {
        const id = key.split('/').pop();
        return { id, title: plan.title };
    });

    const customOrderSubscriptionPlans = [];
    subscriptionPlans.forEach(plan => {
        if (plan.title === 'Every 30 Days') customOrderSubscriptionPlans[0] = plan;
        if (plan.title === 'Every 45 Days') customOrderSubscriptionPlans[1] = plan;
        if (plan.title === 'Every 60 Days') customOrderSubscriptionPlans[2] = plan;
    });

    // Auto-select "Every 30 Days" option
    customOrderSubscriptionPlans.forEach((plan, index) => {
        if (!plan) return;
        
        const isEvery30Days = plan.title === 'Every 30 Days';
        const subscriptionOption = `
            <option data-plan-name="${plan.title}" value="${plan.id}" ${isEvery30Days ? 'selected' : ''}>
                ${plan.title}
            </option>
        `;
        bundleproductSubcriptionOptions.insertAdjacentHTML('beforeend', subscriptionOption);
    });

    // Set the initial selling plan ID for "Every 30 Days"
    const every30DaysPlan = customOrderSubscriptionPlans.find(plan => plan?.title === 'Every 30 Days');
    if (every30DaysPlan) {
        const bundleBuilder = document.querySelector('bundle-builder');
        if (bundleBuilder) {
            bundleBuilder.sellingPlanId = every30DaysPlan.id;
            bundleBuilder.sellingPlanName = every30DaysPlan.title;
        }
    }

    document.querySelector('[js-product-bundle-subscription-wrapper]').style.opacity = 1;

    document.dispatchEvent(new CustomEvent('skioBundlePrice:init'));
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', skioDynamicBundleData);
} else {
    skioDynamicBundleData();
}
</script>

{% schema %}
{
    "name": "JR Testing Dynamic SKIO",
    "settings": [],
    "presets": [
        {
            "name": "JR Testing Dynamic SKIO"
        }
    ]
}
{% endschema %}